===================
Pipeline components
===================

The EHT-HOPS pipeline consists of stages of iterative fringe-fitting and post-processing.
A detailed description of the capabilities of the pipeline can be found in 
`Blackburn et al. (2019) <https://ui.adsabs.harvard.edu/abs/2019ApJ...882...23B/abstract>`_.

Stages in the pipeline
----------------------

.. figure:: components.png
   :alt: Control flow in the EHT-HOPS pipeline

   Control flow in the EHT-HOPS pipeline. The red boxes denote the scripts that are run in each stage of the pipeline.
   The blue boxes denote the location of the data to be calibrated; these data are symlinked from the local archive at the beginning of
   each stage, so that new copies of the same input data files are not created.

The primary function of the pipeline is to perform fringe-fitting or generalized phase calibration of the correlated data. Additional
post-processing steps include conversion of Mark4 data to UVFITS files, performing a priori amplitude calibration, field angle rotation
correction, R/L phase calibration, and network calibration. The pipeline is designed to be run in a series of stages, each of which
iteratively build more complex phase models to calibrate the data.

The `HOPS` `fourfit` program performs fringe-fitting. It takes as input a control file consisting of commands that control data selection
and the calibration parameters to be used. The control files are either generated by the user by repeated inspection of the data and the
calibration solutions. Scripts in the EAT that perform additional calibration steps are also used to generate control files which are passed
to `fourfit` in the next stage.

Automatic simultaneous multi-band data processing is not supported by the pipeline yet. Each band is processed independently.
To avoid code duplication, symbolic links to scripts in band 1 (**hops-b1**) are used to run other bands.

The pipeline consists of the following stages::

   Stage 0 (0.bootstrap): An empty control file is passed to `fourfit` in this stage so that no assumptions about fringe-fitting are made.
   Stage 1 (1.+flags+wins): Bad data identified at the correlation stage or from prior inspection of the data are flagged and parameters such as delay search windows are incorporated into the control file input to `fourfit` in this stage. Also, phase calibration is performed in this stage.
   Stage 2 (2.+phasecal): The R/L phase solutions derived in the previous stage are included in the control file and adhoc phase calibration is performed.
   Stage 3 (3.+adhoc): The adhoc phase solutions derived in the previous stage are included in the control file input to `fourfit` in this stage and R/L delay calibration is performed.
   Stage 4 (4.+delays): The R/L delay solutions derived in the previous stage are accounted for during fringe-fitting and fringe closure is performed on the results of `fourfit`.
   Stage 5 (5.+close): The closure phase solutions derived in the previous stage are appended to the control file and a final round of `fourfit` is performed. The calibrated output files generated in this stage are used in subsequent post-processing steps.

Post-processing stages::

   Stage 6 (6.+uvfits): The calibrated output files generated in the previous stage are converted to UVFITS format. 10-second time-averaged and frequency-averaged versions of UVFITS files are also created.
   Stage 7 (7.+apriori): A priori amplitude calibration and field angle rotation correction is performed on the (unaveraged) UVFITS files from the previous stage. Time and frequency-averaged versions of the UVFITS files are also created.

More on the stages and the steps comprising them in :doc:`Running ehthops <running>`.

Metadata
--------

The **meta** directory hosts the metadata and is structured as follows:

- <campaign>
 - cf
  - cf[0-9]_b[1234]_* (Stage and band-specific control files)
 - SEFD
  - b[1234]
   - [dddd] (HOPS expt no)
    - <source>_<two-letter-station-code>.txt
 - VEX
  - <track>.vex

Currently, the metadata include HOPS control files (**cf**), VEX files (**VEX**), station and source relevant SEFDs (**SEFD**)
for each observing campaign. The VEX and SEFD data are used only for post-processing.

The pipeline scripts pick the appropriate control files (from the **cf** subdirectory) and other relevant metadata during
execution as long as the above directory organization and naming conventions are followed.